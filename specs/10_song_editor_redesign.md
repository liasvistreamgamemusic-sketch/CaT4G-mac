# 編集/作曲画面 リデザイン仕様書

## 概要

CaT4Gの編集画面を`/frontend-design`スキルを使用してリデザインする。
既存機能を維持しつつ、UI/UXを大幅に改善し、ダーク/ライト両モード対応の洗練されたデザインに刷新。

---

## 1. 現状分析

### 1.1 現在の画面構成

```
┌─────────────────────────────────────────────────────┐
│ ヘッダー: 戻る | タイトル | 保存                      │
├──────────────┬──────────────────────────────────────┤
│ 左パネル     │ 右パネル（セクション編集）            │
│ (20%)        │ (80%)                                │
│              │                                      │
│ ・曲情報     │ ┌──────────────────────────────────┐│
│ ・表示設定   │ │ セクション: Intro              ×2 ││
│ ・セクション │ │ ┌────────────────────────────┐  ││
│   ナビ       │ │ │ [C]    [Am]    [F]   [G]   │  ││
│              │ │ │ 歌詞テキスト...              │  ││
│              │ │ └────────────────────────────┘  ││
│              │ └──────────────────────────────────┘│
│              │                                      │
└──────────────┴──────────────────────────────────────┘
```

### 1.2 現在の機能一覧

#### メタデータ編集

- [x] 曲名、アーティスト名
- [x] BPM (20-300)、拍子 (4/4, 3/4, 6/8, 2/4)
- [x] Capo (0-12)、調 (メジャー/マイナー各17種)
- [x] メモ（マルチライン）

#### セクション管理

- [x] セクション名（コンボボックス + 27個の定型名）
- [x] リピート回数 (1-10)
- [x] 追加/削除/順序変更/コピー/折りたたみ

#### 行・歌詞管理

- [x] 歌詞テキスト入力
- [x] インライン記法 `[Chord]` 自動解析
- [x] 行の追加/削除

#### コード管理

- [x] コード追加（ダブルクリック）/編集/削除
- [x] 位置変更: ドラッグ（水平）、キーボード（← →）
- [x] 行間移動: ドラッグ（垂直）、キーボード（↑ ↓）
- [x] コード名オートコンプリート
- [x] オーバーラップ自動解決

#### 演奏方法

- [x] ストローク/アルペジオ選択
- [x] ストロークパターン (↓↑×−)、8テンプレート
- [x] アルペジオ順序（同時弾き対応）、8テンプレート

#### ボイシング・メモ

- [x] 複数フィンガリング表示（CAGEDシステム）
- [x] 難易度・ポジション表示
- [x] 行/コード単位のメモ・注釈

#### UI/UX機能

- [x] 表示トグル（ダイアグラム/演奏方法/メモ）
- [x] 未保存変更検出、確認ダイアログ
- [x] セクションナビゲーション

### 1.3 現状の課題

1. **コード配置の操作性**
   - ドラッグ時のフィードバックが弱い
   - コード追加の発見性が低い（ダブルクリック）
   - 隣接コードとの重なり問題

2. **情報表示の密度**
   - ダイアグラム表示時にコード同士が重なる
   - 演奏情報表示時の幅消費

3. **デザインの一貫性**
   - ダーク/ライトモード未対応
   - 視覚的階層が不明確

---

## 2. リデザイン要件

### 2.1 コアコンセプト

```
「直感的なコード配置」×「コンパクトな情報表示」×「洗練されたダークUI」
```

- **歌詞ベースの配置**: コードを掴んで歌詞の特定文字にドロップ
- **スマート情報表示**: 必要な情報を必要なときに必要な場所で
- **テーマ対応**: ダーク/ライト両モードで美しく機能する

### 2.2 レイアウト基本方針

**2カラム維持**だが、各パネルの責務を明確化:

```
┌─────────────────────────────────────────────────────┐
│ ヘッダー: ← 曲名 | [表示設定] [プレビュー] [保存]   │
├──────────────┬──────────────────────────────────────┤
│ サイドバー   │ エディタエリア                       │
│ (折りたたみ  │                                      │
│  可能)       │ ┌ セクション ────────────────────┐  │
│              │ │                                │  │
│ ・メタデータ │ │  [コード配置エリア]            │  │
│ ・セクション │ │  歌詞入力エリア                │  │
│   リスト     │ │                                │  │
│              │ └────────────────────────────────┘  │
└──────────────┴──────────────────────────────────────┘
```

### 2.3 コード配置の新UIコンセプト

#### ドラッグ&ドロップ強化

```
【ドラッグ開始】
  ↓ コード要素をつかむ
  ↓ 半透明ゴースト表示
  ↓ 歌詞上にスナップポイントをハイライト
【ドロップ】
  ↓ 特定の文字位置にスナップ
  ↓ 衝突時は自動調整 or 警告表示
```

#### コード追加の改善案

- **オプション1**: 歌詞の文字をクリック → コード入力ポップオーバー
- **オプション2**: フローティング「+」ボタン → 歌詞上でドロップ
- **オプション3**: 現状維持（ダブルクリック）+ ツールチップでヒント

### 2.4 情報表示の最適化

#### 表示モード（3段階）

| モード | 表示内容 | 用途 |
| ------ | -------- | ---- |
| **Compact** | コード名のみ | 全体確認、印刷向け |
| **Standard** | コード名 + 小ダイアグラム | 練習中 |
| **Detailed** | 全情報（ダイアグラム+演奏方法+メモ） | 詳細編集 |

#### ダイアグラム表示の工夫

- **ホバー/選択時拡大**: 普段は小さく、操作時に拡大
- **オーバーフロー回避**: コード間隔が狭い場合はダイアグラム非表示
- **サイドパネル詳細**: 選択中コードの詳細は左パネルに大きく表示

#### 演奏情報の表示

- **インジケーター**: `St` / `Ar` の小さなバッジ
- **パターン詳細**: ホバー時にツールチップ or サイドパネル
- **編集**: コード編集モーダル内で設定

---

## 3. コンポーネント設計

### 3.1 新コンポーネント構成

```
SongEditorPage (リデザイン)
├── EditorHeader
│   ├── BackButton
│   ├── SongTitle (inline edit)
│   ├── ViewModeToggle (Compact/Standard/Detailed)
│   ├── PreviewButton
│   └── SaveButton
│
├── EditorSidebar (折りたたみ可能)
│   ├── MetadataPanel
│   │   ├── BPM/拍子/Capo/調
│   │   └── メモ
│   ├── SelectedChordPanel (コンテキスト表示)
│   │   ├── ChordDiagram (大)
│   │   ├── VoicingSelector
│   │   └── PlayingMethodEditor
│   └── SectionNavigator
│
└── EditorCanvas
    ├── SectionBlock (複数)
    │   ├── SectionHeader (名前, リピート, 操作)
    │   └── LineBlock (複数)
    │       ├── ChordTrack (コード配置レイヤー)
    │       │   └── DraggableChord (複数)
    │       └── LyricsInput
    └── AddSectionButton
```

### 3.2 インタラクション設計

#### コードの選択・編集フロー

```
1. シングルクリック → 選択（サイドパネルに詳細表示）
2. ドラッグ → 位置変更
3. ダブルクリック → インライン編集 or モーダル
4. Delete/Backspace → 削除
```

#### キーボードショートカット

| キー | アクション |
| ---- | ---------- |
| ← → | 選択コードの位置微調整 |
| ↑ ↓ | 行間移動 |
| Tab | 次のコードへフォーカス |
| Shift+Tab | 前のコードへフォーカス |
| Delete | 選択コード削除 |
| Escape | 選択解除 |
| Cmd/Ctrl+S | 保存 |

---

## 4. デザインシステム

### 4.1 テーマ設計（ダーク/ライト両対応）

```css
/* CSS Variables */
:root {
  /* ダークテーマ（デフォルト） */
  --bg-primary: #0a0a0f;
  --bg-surface: #14141c;
  --bg-elevated: #1e1e2a;
  --accent-primary: #a855f7;    /* Purple */
  --accent-secondary: #6366f1;  /* Indigo */
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border-default: #2d2d3a;
  --border-focus: #a855f7;
}

[data-theme="light"] {
  --bg-primary: #fafafa;
  --bg-surface: #ffffff;
  --bg-elevated: #f5f5f5;
  --accent-primary: #7c3aed;
  --accent-secondary: #4f46e5;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --border-default: #e2e8f0;
  --border-focus: #7c3aed;
}
```

### 4.2 タイポグラフィ

| 要素 | フォント | サイズ | ウェイト |
| ---- | -------- | ------ | -------- |
| コード名 | monospace | 14px | 600 |
| 歌詞 | sans-serif | 16px | 400 |
| セクション名 | sans-serif | 13px | 500 |
| メタデータラベル | sans-serif | 12px | 500 |

### 4.3 アニメーション

- **ドラッグ中**: `transform: scale(1.05)`, `opacity: 0.8`
- **ドロップ**: `transition: all 0.2s ease-out`
- **ホバー**: `transition: all 0.15s ease`
- **折りたたみ**: `transition: height 0.3s ease`

---

## 5. 実装スコープ

### Phase 1: 基盤リデザイン

1. テーマシステム構築（CSS Variables）
2. EditorHeader リデザイン
3. EditorSidebar リデザイン
4. 基本レイアウト調整

### Phase 2: コード配置UI改善

1. DraggableChord コンポーネント強化
2. スナップポイントビジュアル
3. 衝突検知・解決の視覚化
4. キーボードナビゲーション改善

### Phase 3: 情報表示最適化

1. ViewMode切り替え実装
2. ダイアグラム表示の最適化
3. サイドパネルコンテキスト表示
4. ツールチップ・ホバー情報

### Phase 4: 仕上げ

1. アニメーション追加
2. ライトモード対応
3. アクセシビリティ確認
4. パフォーマンス最適化

---

## 6. 技術的考慮事項

### 6.1 既存コードとの整合性

- 既存の状態管理パターン（props drilling + useCallback）を維持
- 型定義は変更なし
- データフローは現状維持

### 6.2 パフォーマンス

- `useMemo` / `useCallback` の適切な使用
- ドラッグ中の再レンダリング最小化
- CSS-only アニメーション優先

### 6.3 テスト方針

- 各コンポーネントの視覚的確認
- ドラッグ&ドロップの動作確認
- キーボード操作の動作確認
- ダーク/ライト両テーマでの表示確認

---

## 7. TAB譜生成に向けたデータ拡張

### 7.1 現状のデータ構造

```typescript
// 現在の ExtendedChordPosition
interface ExtendedChordPosition {
  chord: string;              // コード名
  position: number;           // 歌詞内位置
  method?: PlayingMethod;     // stroke | arpeggio
  strokePattern?: StrokeDirection[];  // ↓↑×−
  arpeggioOrder?: ArpeggioElement[];  // 弦順序
  annotation?: string;        // メモ
  voicingId?: UUID;          // 押さえ方ID
}
```

### 7.2 TAB譜生成に不足している情報

| 情報 | 現状 | 必要性 | 説明 |
| ---- | ---- | ------ | ---- |
| **拍数/長さ** | なし | 必須 | そのコードを何拍弾くか |
| **特殊奏法** | なし | 重要 | ハンマリング、スライド、ベンド等 |
| **ダイナミクス** | なし | あると良い | 音の強さ（p, mf, f等） |
| **テンポ変化** | なし | あると良い | セクション/行単位のBPM変更 |

### 7.3 拡張データ構造の提案

```typescript
// 演奏テクニック
type PlayingTechnique =
  | 'hammer-on'      // ハンマリング
  | 'pull-off'       // プリングオフ
  | 'slide-up'       // スライドアップ
  | 'slide-down'     // スライドダウン
  | 'bend'           // ベンド（チョーキング）
  | 'vibrato'        // ビブラート
  | 'palm-mute'      // パームミュート
  | 'harmonic'       // ハーモニクス
  | 'let-ring'       // 余韻を残す
  | 'accent';        // アクセント

// ダイナミクス
type Dynamics = 'ppp' | 'pp' | 'p' | 'mp' | 'mf' | 'f' | 'ff' | 'fff';

// 拡張されたコード位置（TAB譜対応版）
interface ExtendedChordPosition {
  // 既存フィールド
  chord: string;
  position: number;
  method?: PlayingMethod;
  strokePattern?: StrokeDirection[];
  arpeggioOrder?: ArpeggioElement[];
  annotation?: string;
  voicingId?: UUID;

  // TAB譜用 新規フィールド
  duration?: number;              // 拍数（1=1拍, 0.5=半拍, 2=2拍）
  techniques?: PlayingTechnique[]; // 適用するテクニック
  dynamics?: Dynamics;            // 音の強さ
  tieToNext?: boolean;            // 次のコードとタイで繋ぐ
}

// セクションレベルのテンポ変更
interface Section {
  // 既存フィールド...
  bpmOverride?: number;   // このセクション専用のBPM
  tempoChange?: 'rit' | 'accel' | 'a tempo';  // テンポ変化指示
}

// 行レベルの追加情報
interface Line {
  // 既存フィールド...
  dynamicsOverride?: Dynamics;  // この行の基本ダイナミクス
}
```

### 7.4 UIへの影響

#### コード編集モーダルの拡張

```
┌────────────────────────────────────────────────────┐
│ コード編集: Am                                      │
├────────────────────────────────────────────────────┤
│                                                    │
│ [押さえ方タブ] [演奏方法タブ] [詳細設定タブ]        │
│                                                    │
│ ┌──────────────────────────────────────────────┐  │
│ │ 詳細設定 (新規)                               │  │
│ │                                               │  │
│ │ 拍数: [  2  ] 拍  ← 新規                     │  │
│ │                                               │  │
│ │ テクニック: □ ハンマリング  □ スライド       │  │
│ │            □ ベンド       □ パームミュート   │  │
│ │            □ ビブラート   □ ハーモニクス    │  │
│ │                                               │  │
│ │ ダイナミクス: [●] p  [ ] mf  [ ] f           │  │
│ │                                               │  │
│ └──────────────────────────────────────────────┘  │
│                                                    │
│              [キャンセル]  [保存]                   │
└────────────────────────────────────────────────────┘
```

#### 行表示での拍数可視化

```
コード表示:
  Am (2拍)    G (2拍)    F (4拍)
  ├──┤        ├──┤        ├────┤

歌詞:
  この街の どこかで 君は今...
```

#### テクニックインジケーター

```
コード名の横に小アイコンで表示:
  Am h     ← ハンマリング
  G  /     ← スライドアップ
  F  ~     ← ビブラート
```

### 7.5 TAB譜出力仕様

#### 出力形式

- **PDF/印刷用**: アプリ内でレンダリング → PDF出力
- **プレビュー**: 編集画面内でリアルタイムTAB表示（将来対応）

#### TAB譜の構成要素

```
┌─────────────────────────────────────────────────────────────┐
│ 曲名: サンプルソング                   Artist: アーティスト名 │
│ Key: C  |  BPM: 120  |  Capo: 2  |  Time: 4/4              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ [Intro]                                                     │
│                                                             │
│    Am          G           F           C                    │  ← コード名
│    ♩  ♩  ♩  ♩   ♩  ♩  ♩  ♩   ♩  ♩  ♩  ♩   ♩  ♩  ♩  ♩       │  ← リズム表記
│ e|--0--0--0--0-|--3--3--3--3-|--1--1--1--1-|--0--0--0--0-|  │
│ B|--1--1--1--1-|--0--0--0--0-|--1--1--1--1-|--1--1--1--1-|  │
│ G|--2--2--2--2-|--0--0--0--0-|--2--2--2--2-|--0--0--0--0-|  │  ← 6弦TAB
│ D|--2--2--2--2-|--0--0--0--0-|--3--3--3--3-|--2--2--2--2-|  │
│ A|--0--0--0--0-|--2--2--2--2-|--3--3--3--3-|--3--3--3--3-|  │
│ E|-------------|--3--3--3--3-|--1--1--1--1-|-------------|  │
│    ↓  ↑  ↓  ↑   ↓  ↑  ↓  ↑   ↓  ↑  ↓  ↑   ↓  ↑  ↓  ↑    │  ← ストローク
│    |     |     |     |     |     |     |     |     |       │  ← 拍グリッド
│    1  &  2  &   1  &  2  &   1  &  2  &   1  &  2  &       │
│                                                             │
│ [Verse]                                                     │
│                                                             │
│ この街の  どこかで  君は今...                                │  ← 歌詞
│    Am          G           F           C                    │
│ ...                                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### リズム表記の対応

| 音符 | 拍数 | 表記 |
| ---- | ---- | ---- |
| 全音符 | 4拍 | 𝅝 |
| 2分音符 | 2拍 | 𝅗𝅥 |
| 4分音符 | 1拍 | ♩ |
| 8分音符 | 0.5拍 | ♪ |
| 16分音符 | 0.25拍 | 𝅘𝅥𝅯 |
| 付点4分 | 1.5拍 | ♩. |

#### 特殊奏法の表記

| テクニック | TAB表記 | 例 |
| ---------- | ------- | --- |
| ハンマリング | h | 5h7 |
| プリングオフ | p | 7p5 |
| スライドアップ | / | 5/7 |
| スライドダウン | \ | 7\5 |
| ベンド | b | 7b9 |
| ビブラート | ~ | 7~ |
| パームミュート | P.M. | P.M.--- |
| ハーモニクス | <> | <12> |

#### PDF出力設定（将来実装）

- **用紙サイズ**: A4 / Letter / 任意
- **向き**: 縦 / 横
- **フォントサイズ**: 小 / 中 / 大
- **1ページあたりの小節数**: 自動 / 指定
- **含める要素**: チェックボックスで選択可能

---

## 8. 実装スコープ（更新版）

### Phase 1: 基盤リデザイン（UI/UX改善）

1. テーマシステム構築（CSS Variables + ダーク/ライト）
2. EditorHeader リデザイン
3. EditorSidebar リデザイン
4. 基本レイアウト調整

### Phase 2: コード配置UI改善

1. DraggableChord コンポーネント強化
2. スナップポイントビジュアル
3. 衝突検知・解決の視覚化
4. キーボードナビゲーション改善

### Phase 3: TAB譜データ対応

1. **型定義の拡張**（duration, techniques, dynamics）
2. **コード編集モーダル拡張**（詳細設定タブ追加）
3. **拍数の視覚化UI**
4. **テクニックインジケーター**

### Phase 4: 情報表示最適化

1. ViewMode切り替え実装
2. ダイアグラム表示の最適化
3. サイドパネルコンテキスト表示
4. ツールチップ・ホバー情報

### Phase 5: 仕上げ

1. アニメーション追加
2. ライトモード完全対応
3. アクセシビリティ確認
4. パフォーマンス最適化

---

## 9. 関連ファイル

### 編集対象

- `src/components/SongEditorPage.tsx` - メインページ
- `src/components/editor/` - 全エディタコンポーネント
- `src/types/database.ts` - 型定義（TAB譜用フィールド追加）
- `src/index.css` - テーマCSS Variables

### 参照

- `specs/09_ui_design.md` - UIデザイン仕様
- `specs/07_transpose.md` - 転調・コード仕様
